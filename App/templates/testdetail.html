{% extends "base.html" %} {% block csses %}
<style>
    * {
        padding: 0;
        margin: 0;
    }

    #image {
        display: -webkit-flex;
        display: flex;
        flex-wrap: nowrap;
        justify-content: flex-start;
    }

    .image_menu {
        order: 0;
        flex: none;
        width: 200px;
        height: auto;
    }

    .image_middle {
        width: 5px;
        height: auto;
        background-color: black;
        order: 1;
        flex: none;
    }

    .image_right {
        order: 2;
        flex: 1 1 auto;
    }

    .image_right>div {
        width: 100%;
        margin: 0px -2px;
        overflow: auto;
    }
</style>
{% endblock %} {% block page_content %}

<div id="image">

    <div class="image_menu" v-if="isshowmenu" v-bind:style="rightmenucss">
        <select v-model="imgtype">
            <option value="adaptw">适应宽</option>
            <option value="adapt">合适</option>
            <option value="repeat">平铺</option>
            <option value="orign">原图</option>
            <option value="adapth">适应高</option>
        </select>
        <div v-for="(item,index) in Images">
            <template v-if="index==CurrentIndex">
                <img style="width:100%;height:90px;border:1px solid" v-bind:src="'../'+item.url" />
            </template>
            <template v-if="index!=CurrentIndex">
                <img style="width:100%;height:90px" v-bind:src="'../'+item.url" />
            </template>
        </div>
    </div>
    <div class="image_middle" v-on:click="setshowleft()">
    </div>
    <div class="image_right">
        <div id="image_box" align="center" v-bind:style="rightcontentcss">
            <span v-bind:style="rightblackcss"></span>
            <img style="vertical-align:middle" v-bind:style="rightimgcss" v-bind:src="'../'+CurrentImage.url" />
        </div>
    </div>
</div>
{% endblock %} {% block scripts %}
<script type="text/javascript" language="javascript" src="/App/static/jquery.mousewheel.js" charset="utf-8"></script>

<script>
    const store = new Vuex.Store({
        state: {
            ImageData: {
                Items: [],
                CurrentIndex: -1,
            },
            SelectData: {
                Index: -1,
                StarIndex: -1,
                Section: 10,
                IsEnd: false,
                IsLoading: false,
                Params: {
                    params: {
                        Tag: '',
                        Score: 0,
                        Sort: '',
                    }
                }
            },
        },
        getters: {
            // CurrentImage: state => {
            //     if(CurrentIndex>-1)
            //         return store.state.ImageData.Items[store.state.ImageData.CurrentIndex];
            //     else
            //         return null;
            // },
        },
        mutations: {
            indexstar(state) {
                if(state.SelectData.Index<3-1)
                    state.ImageData.CurrentIndex = state.SelectData.Index;
                else
                    state.ImageData.CurrentIndex = 3-1;
            },
            indexchange(state, isUp) {
                if(isUp){
                    if(state.ImageData.Items.length<state.ImageData.CurrentIndex+1)
                            state.ImageData.CurrentIndex = state.ImageData.Items.length-1;
                    else
                        state.ImageData.CurrentIndex = state.ImageData.CurrentIndex-1;
                }
                else{
                    if(state.ImageData.CurrentIndex<3-1){
                        if(state.ImageData.Items.length<state.ImageData.CurrentIndex+1)
                            state.ImageData.CurrentIndex = state.ImageData.Items.length-1;
                        else
                            state.ImageData.CurrentIndex = state.ImageData.CurrentIndex+1;
                    }
                }
            },
            startdata(state, obj) {
                state.SelectData.Index = obj.Index;
                if (obj.Index - 3 > -1) {
                    state.SelectData.StarIndex = obj.Index - 3;
                    state.ImageData.CurrentIndex = 3 - 1;
                } else {
                    state.SelectData.StarIndex = obj.Index;
                    state.ImageData.CurrentIndex = obj.Index;
                }
                state.SelectData.Params.params.Tag = obj.Tag;
                state.SelectData.Params.params.Score = obj.Score;
                state.SelectData.Params.params.Sort = obj.Sort;
            }
        },
        actions: {
            start(context) {
                API.image.getsbysection(
                    function (data) {
                        if (data && data.length > 0) {
                            data.forEach(element => {
                                context.state.ImageData.Items.push(element);
                            });
                            context.commit("indexstar", false);
                        }
                    },
                    context.state.SelectData.Index,
                    context.state.SelectData.Index + context.state.SelectData.Section,
                    context.state.SelectData.Params)
            },
            change(context, isUp) {
                index = context.state.SelectData.Index;
                section = context.state.SelectData.Section;
                if (isUp) {
                    if (context.state.SelectData.Index <= 0)
                        return;
                    else {
                        starIndex = context.state.SelectData.StarIndex - 1;
                        endIndex = starIndex + 1;
                    }
                }
                else {
                    if (context.state.SelectData.IsEnd)
                        return;
                    else {
                        starIndex = context.state.SelectData.StarIndex + context.state.SelectData.Section - 1;
                        endIndex = starIndex + 1;
                    }
                }
                if (!context.state.SelectData.IsLoading) {//未结束才进行尝试,且未正在读取数据 
                    context.state.imagedata.isloading = true;
                    API.image.getsbysection(
                        function (data) {
                            if (data && data.length > 0) {
                                context.state.ImageData.Items.push(data[0]);
                            }                                
                            context.commit("indexchange", isUp);
                        },
                        context.state.SelectData.index,
                        context.state.SelectData.index + 1,
                        context.state.SelectData.Params)                    
                }
            }
        }
    })

    var image = new Vue({
        el: '#image',
        store,
        data: {
            items: [],
            currentindex: 0,
            isshowmenu: true,
            imgtype: "adaptw",
            windowheight: 0,
            imgheight: 0,
            imgwidth: 0,
        },
        computed: {
            Images: function () {
                return store.state.ImageData.Items;
            },
            CurrentIndex: function () {
                return store.state.ImageData.CurrentIndex;
            },
            CurrentImage: function () {
                if (this.Images.length > 0 && this.CurrentIndex > -1)
                    return this.Images[this.CurrentIndex]
                else
                    return { url: '' };
            },
            rightmenucss: function () {
                var obj = { overflow:'hidden','box-sizing': 'border-box', height: this.windowheight - 10 + 'px' };
                return obj;
            },
            rightcontentcss: function () {
                var obj = { 'box-sizing': 'border-box', height: this.windowheight - 10 + 'px' };
                switch (this.imgtype) {
                    case "adaptw":
                        obj.overflow = "auto";
                        break;
                };
                return obj;
            },
            rightblackcss: function () {
                var obj = { 'line-height': this.windowheight - 10 + 'px' };
                return obj;
            },
            rightimgcss: function () {
                var obj = {};
                switch (this.imgtype) {
                    case "repeat":
                        obj = { width: "100%", height: "100%" };
                        break;
                    case "adaptw":
                        obj = { width: "100%" };
                        break;
                    case "adapth":
                        obj = { height: "100%" };
                        break;
                    case "adapt":
                        var box = $("#image_box");
                        if (this.imgwidth != 0 && this.imgheight / this.imgwidth > box.height() / box.width()) {
                            obj = { height: "100%" };
                        } else {
                            obj = { width: "100%" };
                        }
                        break;
                    case "orign":
                        break;
                };
                return obj;
            },
        },
        watch: {
            CurrentImage() {
                self = this;
                self.$nextTick(function () {
                    var img = $("#image_box img")[0];
                    if (img) {
                        self.imgheight = img.naturalHeight;
                        self.imgwidth = img.naturalWidth;
                    }
                });
            },
        },
        methods: {
            setshowleft() {
                this.isshowmenu = !this.isshowmenu;
            },
            setheight() {
                this.windowheight = $(window).height()
            },
            change(isup) {
                scrollheight = parseFloat($('#image_box').scrollTop());
                if (isup && scrollheight < 3) {
                    this.id = parseInt(this.id) - 1;
                    store.dispatch('change', true)
                }
                else if (!isup && ($('#image_box').height() + scrollheight > $('#image_box img').height() - 3)) {
                    this.id = parseInt(this.id) + 1;
                    store.dispatch('change', false)
                    $('#image_box').scrollTop(0);
                }
            },
        },
        mounted: function () {
            store.commit("startdata", { Index: parseInt(Vue.GetUrlParam("index")), Tag: Vue.GetUrlParam("tag"), Score: Vue.GetUrlParam("score"), Sort: Vue.GetUrlParam("sort") })
            store.dispatch('start')
            this.setheight();
            self = this;
            $(window).resize(function () {
                self.setheight();
            });
            $('#image_box')
                .mousewheel(function (event, delta) {
                    var isup = delta > 0;
                    self.change(isup);
                })
        },
    })
</script> {% endblock %}